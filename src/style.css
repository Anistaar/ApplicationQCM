:root{
  --bg:#0b0f14; --fg:#e8eaed; --muted:#b4bfc9; --brd:#22303c;
  --ok-bg:#123d28; --ok-brd:#1f6b45; --ok-fg:#adf0c0;
  --ko-bg:#3a1517; --ko-brd:#5a2225; --ko-fg:#f9b3b6;
  --warn-bg:#2a2417; --warn-brd:#4b4130;
  --primary:#e8eaed;
  --accent:#84cc16;
  /* Design system tokens */
  --radius-xs:4px; --radius-sm:6px; --radius-md:10px; --radius-lg:12px;
  --space-1:4px; --space-2:6px; --space-3:8px; --space-4:12px; --space-5:16px; --space-6:20px;
  --font-xs:11px; --font-sm:13px; --font-base:14px; --font-md:16px; --font-lg:20px; --font-xl:24px;
  --shadow-sm:0 1px 2px rgba(0,0,0,.3); --shadow-md:0 4px 12px rgba(0,0,0,.25); --shadow-lg:0 8px 28px rgba(0,0,0,.35);
  --focus-ring:0 0 0 3px rgba(132,204,22,.35);
}

/* Variante claire si besoin */
html[data-theme="light"]{
  --bg:#ffffff; --fg:#111; --muted:#4b5563; --brd:#e5e7eb;
  --ok-bg:#eafaf0; --ok-brd:#b4e4c7; --ok-fg:#14532d;
  --ko-bg:#fef2f2; --ko-brd:#f5c2c7; --ko-fg:#7f1d1d;
  --warn-bg:#fff8f0; --warn-brd:#f3d5b0;
  --primary:#111;
  --accent:#2563eb;
}

/* -------- Skip links accessibility -------- */
.skip-link:focus {
  position: fixed !important;
  left: 8px !important;
  top: 8px !important;
  outline: 3px solid var(--accent);
  outline-offset: 2px;
  box-shadow: var(--shadow-lg);
}

/* -------- Layout global compact -------- */
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;background:var(--bg);color:var(--fg);
  font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  font-size:var(--font-base);
  -webkit-font-smoothing:antialiased;
}
.wrap{max-width:820px;margin:0 auto;padding:0 12px 24px}

/* Topbar collante */
.topbar{
  position:sticky; top:0; z-index:50;
  background:var(--bg); border-bottom:1px solid var(--brd);
  display:flex; gap:12px; align-items:center; justify-content:space-between;
  padding:10px 0;
}
h1{margin:0; font-size:20px}
.subtitle{margin:6px 0 12px;color:var(--muted);font-size:14px}

.theme-toggle{display:flex;align-items:center;gap:8px;font-weight:600}
.theme-toggle input{transform:scale(1.1)}

/* Carte réglages */
.card{
  border:1px solid var(--brd);border-radius:var(--radius-lg);background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0));
  padding:var(--space-4);margin:var(--space-4) 0;position:relative;overflow:hidden;
}
.card:hover{border-color:var(--accent);}
.card.compact{padding:var(--space-3)}
.card-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:var(--space-3)}
.card-title{font-size:var(--font-md);font-weight:600;margin:0}
.card-subtitle{font-size:var(--font-sm);color:var(--muted);margin:0}
.row{display:grid;gap:6px;margin-bottom:10px}
label{font-weight:600;font-size:14px}
select,input{
  padding:8px 10px;border-radius:10px;border:1px solid var(--brd);
  background:transparent;color:var(--fg);font-size:14px;
}
select option{background:var(--bg);color:var(--fg)}
.modes{display:flex;gap:14px}

/* Boutons */
.btn{padding:var(--space-3) var(--space-4);border-radius:var(--radius-md);cursor:pointer;font-size:var(--font-base);font-weight:500;line-height:1.2;display:inline-flex;align-items:center;gap:6px;user-select:none;transition:.15s background,.15s color,.15s border-color}
.btn:focus-visible{outline:none;box-shadow:var(--focus-ring)}
.btn-primary{border:1px solid var(--accent);background:var(--accent);color:var(--bg);}
.btn-primary:hover{filter:brightness(1.15)}
.btn-outline{border:1px solid var(--brd);background:transparent;color:var(--fg)}
.btn-outline:hover{border-color:var(--accent);color:var(--accent)}
.btn-ghost{border:1px solid transparent;background:transparent;color:var(--fg)}
.btn-ghost:hover{background:rgba(255,255,255,.05)}
.btn-danger{border:1px solid var(--ko-brd);background:var(--ko-bg);color:var(--ko-fg)}
.btn-danger:hover{filter:brightness(1.2)}
.btn:disabled{opacity:.55;cursor:not-allowed}

/* Legacy button aliases */
.primary{padding:var(--space-3) var(--space-4);border-radius:var(--radius-md);cursor:pointer;font-size:var(--font-base);font-weight:500;display:inline-flex;align-items:center;gap:6px;border:1px solid var(--accent);background:transparent;color:var(--accent);transition:.15s background,.15s color,.15s border-color}
.primary:hover{background:var(--accent);color:var(--bg)}
.primary:focus-visible{outline:none;box-shadow:var(--focus-ring)}
.secondary{padding:var(--space-3) var(--space-4);border-radius:var(--radius-md);cursor:pointer;font-size:var(--font-base);font-weight:500;display:inline-flex;align-items:center;gap:6px;border:1px solid var(--brd);background:transparent;color:var(--fg);transition:.15s background,.15s color,.15s border-color}
.secondary:hover{border-color:var(--accent);color:var(--accent)}
.secondary:focus-visible{outline:none;box-shadow:var(--focus-ring)}

/* Head + progression */
.head{display:flex;gap:10px;justify-content:space-between;flex-wrap:wrap;margin:8px 0}
.badge{display:inline-flex;align-items:center;gap:4px;padding:2px 8px;border-radius:999px;border:1px solid var(--brd);font-size:12px;color:var(--muted);font-weight:500;letter-spacing:.3px;white-space:nowrap}
.badge[data-variant="accent"]{border-color:var(--accent);color:var(--accent)}
.badge[data-variant="danger"]{border-color:var(--ko-brd);color:var(--ko-fg);background:var(--ko-bg)}
.badge[data-variant="ok"]{border-color:var(--ok-brd);color:var(--ok-fg);background:var(--ok-bg)}
.progress{height:8px;background:transparent;border-radius:999px;border:1px solid var(--brd);overflow:hidden}
.progress__bar{height:100%;background:var(--accent);transition:width .2s ease}

/* -------- Carte question compacte -------- */
.card--q{position:relative;border:1px solid var(--brd);border-radius:var(--radius-lg);background:transparent;padding:var(--space-4);margin:var(--space-4) 0;max-height:62vh;overflow:auto;scroll-behavior:smooth}
.qtitle{font-weight:800;margin:0 0 6px 0}
.block{margin:8px 0}
.hint{margin-top:4px}
small.muted{color:var(--muted)}

/* Options compactes en grille 2 colonnes */
.options{display:grid;gap:8px;margin:10px 0}
@media (min-width:768px){
  .options{grid-template-columns:repeat(2,minmax(0,1fr))}
}
.options--inline{grid-template-columns:none;grid-auto-flow:column;justify-content:start}

.opt{display:flex;gap:var(--space-2);align-items:center;padding:var(--space-3) var(--space-4);border:1px solid var(--brd);border-radius:var(--radius-md);transition:.15s;background:rgba(255,255,255,.01)}
.opt input{transform:scale(1.05);margin-top:1px}
.opt.good{background:var(--ok-bg);border-color:var(--ok-brd)}
.opt.bad{background:var(--ko-bg);border-color:var(--ko-brd)}
.opt .label{flex:1}
.opt:focus-within{outline:none;box-shadow:var(--focus-ring)}
.mark{margin-left:auto;font-weight:800}
.mark--good{color:var(--ok-fg)}
.mark--bad{color:var(--ko-fg)}

/* Feedback repliable */
.feedback{margin-top:var(--space-3);border-radius:var(--radius-md);padding:var(--space-3)}
.feedback.ok{background:var(--ok-bg);border:1px solid var(--ok-brd)}
.feedback.ko{background:var(--ko-bg);border:1px solid var(--ko-brd)}
details.feedback > summary{
  cursor:pointer; list-style:none; font-weight:700;
}
details.feedback > summary::-webkit-details-marker{display:none}
details.feedback > summary:focus-visible{
  outline: 2px solid var(--accent);
  outline-offset: 2px;
}

/* Bouton “Suivant” flottant */
.fab-next{position:fixed;right:18px;bottom:18px;z-index:60;border-radius:999px;padding:10px 14px;font-weight:700;border:1px solid var(--accent);background:var(--accent);color:var(--bg);box-shadow:var(--shadow-md);cursor:pointer}
.fab-next:disabled{opacity:.6;cursor:not-allowed}

/* Résultats */
.list{display:grid;gap:8px;padding-left:18px}
.list li{list-style:decimal;border:1px solid var(--brd);border-radius:12px;padding:10px}
.list li.ok{background:var(--ok-bg);border-color:var(--ok-brd)}
.list li.ko{background:var(--warn-bg);border-color:var(--warn-brd)}

/* ----- Dossier: stats par matière ----- */
.folder-stats-grid{display:grid;gap:var(--space-3);grid-template-columns:repeat(auto-fit,minmax(140px,1fr))}
.folder-stats-grid .stat{border:1px solid var(--brd);border-radius:var(--radius-md);padding:var(--space-3);display:flex;flex-direction:column;gap:4px;background:rgba(255,255,255,.015)}
.folder-stats-grid .label{font-size:12px;color:var(--muted)}
.folder-stats-grid .value{font-weight:800}
.badge.ok{background:var(--ok-bg);border-color:var(--ok-brd);color:var(--ok-fg)}
.badge.warn{background:var(--warn-bg);border-color:var(--warn-brd);color:#b45309}
.badge.danger{background:var(--ko-bg);border-color:var(--ko-brd);color:var(--ko-fg)}

/* Focus utility */
.focus-ring:focus-visible{outline:none;box-shadow:var(--focus-ring)}

/* DragMatch styles */
.drag-container{margin:var(--space-4) 0}
.drag-items{display:flex;flex-direction:column;gap:var(--space-3);margin-bottom:var(--space-4)}
.drag-item-row{display:grid;grid-template-columns:1fr 1fr;gap:var(--space-3);align-items:center;padding:var(--space-3);border:1px solid var(--brd);border-radius:var(--radius-md);transition:.15s}
.drag-item-row.correct{background:var(--ok-bg);border-color:var(--ok-brd)}
.drag-item-row.incorrect{background:var(--ko-bg);border-color:var(--ko-brd)}
.drag-item-label{font-weight:600}
.drag-drop-zone{min-height:40px;padding:var(--space-2);border:2px dashed var(--brd);border-radius:var(--radius-sm);display:flex;align-items:center;justify-content:center;transition:.15s;cursor:pointer}
.drag-drop-zone:focus-visible{outline:none;box-shadow:var(--focus-ring);border-color:var(--accent)}
.drag-drop-zone.drag-over{border-color:var(--accent);background:rgba(132,204,22,.1)}
.drag-drop-zone .placeholder{color:var(--muted);font-size:var(--font-sm)}
.drag-matches-pool{margin-top:var(--space-4);padding:var(--space-3);border:1px solid var(--brd);border-radius:var(--radius-md);background:rgba(255,255,255,.01)}
.pool-label{font-weight:600;margin-bottom:var(--space-2);font-size:var(--font-sm);color:var(--muted)}
.drag-matches{display:flex;flex-wrap:wrap;gap:var(--space-2)}
.drag-match-chip{padding:6px 12px;border-radius:var(--radius-md);background:var(--accent);color:var(--bg);font-weight:600;cursor:grab;user-select:none;transition:.15s;border:2px solid transparent;font-size:var(--font-sm)}
.drag-match-chip:hover{filter:brightness(1.15)}
.drag-match-chip:focus-visible{outline:none;box-shadow:0 0 0 3px rgba(132,204,22,.5);border-color:var(--bg)}
.drag-match-chip.kb-selected{border-color:var(--bg);box-shadow:0 0 0 3px rgba(132,204,22,.5),0 0 8px rgba(132,204,22,.6);animation:pulse-kb .8s ease-in-out infinite}
.drag-match-chip.dragging{opacity:.5;cursor:grabbing}
.drag-match-chip.used{opacity:.3;pointer-events:none}
.drag-match-chip[draggable="false"]{cursor:default}
.correct-answer{color:var(--ok-fg);font-weight:600;font-size:var(--font-sm)}

@keyframes pulse-kb{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}

/* FormulaBuilder styles */
.formula-builder-container{margin:var(--space-5) 0;padding:var(--space-5);border:1px solid var(--brd);border-radius:var(--radius-lg);background:rgba(255,255,255,.02)}

.formula-result-display{margin-bottom:var(--space-5);padding:var(--space-5);background:rgba(0,0,0,.3);border-radius:var(--radius-md);border:1px solid var(--brd)}
.formula-label{font-size:var(--font-sm);color:var(--muted);margin-bottom:var(--space-3);text-transform:uppercase;letter-spacing:0.5px}
.formula-equation{display:flex;align-items:center;gap:var(--space-3)}
.formula-var{font-size:var(--font-xl);font-weight:700;color:var(--accent);font-family:'Courier New',monospace}
.formula-construction{flex:1;min-height:52px;padding:var(--space-4);background:rgba(0,0,0,.2);border:2px solid var(--brd);border-radius:var(--radius-md);display:flex;align-items:center;flex-wrap:wrap;gap:var(--space-2);position:relative;transition:.2s}
.formula-construction.correct-formula{border-color:var(--ok-brd);background:rgba(132,204,22,.1);box-shadow:0 0 0 3px rgba(132,204,22,.15)}
.formula-placeholder{color:var(--muted);font-style:italic;font-size:var(--font-sm)}

.tokens-wrapper{display:flex;flex-wrap:wrap;gap:var(--space-2);align-items:center}
.token-chip{padding:6px 12px;background:linear-gradient(135deg,#84cc16,#65a30d);color:var(--bg);font-weight:600;border-radius:var(--radius-sm);font-size:var(--font-sm);font-family:'Courier New',monospace;box-shadow:var(--shadow-sm);animation:slideIn .2s ease}
.token-chip.space-chip{background:rgba(132,204,22,.3);color:var(--accent);border:1px dashed var(--accent)}

.formula-progress{height:6px;background:rgba(0,0,0,.3);border-radius:3px;margin-bottom:var(--space-5);overflow:hidden;border:1px solid var(--brd)}
.progress-bar{height:100%;background:linear-gradient(90deg,#84cc16,#65a30d);transition:width .3s ease;border-radius:2px}
.progress-bar.complete{background:linear-gradient(90deg,#4caf50,#2e7d32);box-shadow:0 0 8px rgba(76,175,80,.6)}

.formula-tokens-section{margin-bottom:var(--space-5)}
.tokens-label{font-size:var(--font-sm);color:var(--muted);margin-bottom:var(--space-3);font-weight:500}
.formula-tokens{display:flex;flex-wrap:wrap;gap:var(--space-3);padding:var(--space-4);border:1px solid var(--brd);border-radius:var(--radius-md);background:rgba(255,255,255,.01)}
.formula-token{padding:10px 16px;border-radius:var(--radius-md);background:linear-gradient(135deg,#84cc16,#65a30d);color:var(--bg);font-weight:600;cursor:pointer;user-select:none;transition:.15s;border:none;font-size:var(--font-base);font-family:'Courier New',monospace;box-shadow:var(--shadow-sm);position:relative}
.formula-token:hover{filter:brightness(1.2);transform:translateY(-2px) scale(1.05);box-shadow:var(--shadow-md)}
.formula-token:active,.formula-token.used{transform:scale(.9)}
.formula-token.used{animation:tokenUsed .3s ease}

.formula-controls{display:flex;gap:var(--space-3);flex-wrap:wrap}
.btn-formula-action{padding:var(--space-3) var(--space-5);border:1px solid var(--brd);border-radius:var(--radius-md);background:rgba(255,255,255,.05);color:var(--fg);font-weight:500;cursor:pointer;transition:.15s;font-size:var(--font-sm);display:flex;align-items:center;gap:var(--space-2)}
.btn-formula-action:hover{background:rgba(255,255,255,.1);border-color:var(--accent);transform:translateY(-1px)}
.btn-hint{background:linear-gradient(135deg,rgba(132,204,22,.2),rgba(132,204,22,.1));border-color:var(--accent)}
.btn-hint:hover{background:linear-gradient(135deg,rgba(132,204,22,.3),rgba(132,204,22,.15));box-shadow:0 0 8px rgba(132,204,22,.3)}

.hint-feedback{position:absolute;top:-35px;left:50%;transform:translateX(-50%);background:var(--accent);color:var(--bg);padding:var(--space-2) var(--space-4);border-radius:var(--radius-md);font-size:var(--font-xs);font-weight:600;white-space:nowrap;animation:hintPop .5s ease;box-shadow:var(--shadow-md);z-index:10}

@keyframes slideIn{from{opacity:0;transform:scale(.8)}to{opacity:1;transform:scale(1)}}
@keyframes tokenUsed{0%{transform:scale(1)}50%{transform:scale(.85);filter:brightness(1.3)}100%{transform:scale(1)}}
@keyframes hintPop{0%{opacity:0;transform:translateX(-50%) translateY(10px) scale(.8)}100%{opacity:1;transform:translateX(-50%) translateY(0) scale(1)}}

.formula-feedback{margin-top:var(--space-4);padding:var(--space-4);border-radius:var(--radius-md);font-size:var(--font-sm);animation:fadeIn .3s ease}
.formula-feedback.correct{background:var(--ok-bg);border:1px solid var(--ok-brd);color:var(--ok-fg)}
.formula-feedback.incorrect{background:var(--ko-bg);border:1px solid var(--ko-brd);color:var(--ko-fg)}

/* OpenQ (Questions Ouvertes) styles */
.openq-container{margin:var(--space-4) 0}
.openq-container textarea{
  width:100%;padding:var(--space-3);border:1px solid var(--brd);
  border-radius:var(--radius-md);background:transparent;color:var(--fg);
  font-family:inherit;font-size:var(--font-base);resize:vertical;
  min-height:150px;line-height:1.6;transition:.15s
}
.openq-container textarea:focus{
  outline:none;border-color:var(--accent);box-shadow:var(--focus-ring)
}
.openq-container textarea:disabled{opacity:.6;cursor:not-allowed}
.char-counter{
  text-align:right;font-size:var(--font-sm);color:var(--muted);margin-top:4px
}
.openq-feedback{
  margin-top:var(--space-4);padding:var(--space-4);
  border-radius:var(--radius-md);border:1px solid var(--brd);
  animation:slide-in-down .3s ease-out
}
.openq-feedback-correct{background:var(--ok-bg);border-color:var(--ok-brd)}
.openq-feedback-incorrect{background:var(--ko-bg);border-color:var(--ko-brd)}
.openq-feedback .feedback-header{
  font-size:var(--font-md);margin-bottom:var(--space-3)
}
.openq-feedback .missing-keywords{
  padding:var(--space-2) var(--space-3);
  background:rgba(255,255,255,.05);
  border-radius:var(--radius-sm);
  margin-bottom:var(--space-3);
  font-size:var(--font-sm)
}
.openq-feedback .reference-course{margin-top:var(--space-3)}
.openq-feedback .reference-course summary{
  cursor:pointer;font-weight:600;color:var(--accent);
  user-select:none;padding:var(--space-2) 0;
  transition:.15s color
}
.openq-feedback .reference-course summary:hover{filter:brightness(1.2)}
.openq-feedback .reference-course p{
  margin-top:var(--space-2);padding:var(--space-3);
  background:rgba(255,255,255,.02);border-radius:var(--radius-sm);
  font-size:var(--font-sm);line-height:1.7;
  border-left:3px solid var(--accent)
}
.openq-feedback .explanation{
  margin-top:var(--space-3);font-size:var(--font-sm);
  color:var(--muted);font-style:italic
}

/* Micro-interactions animations */
@keyframes pulse-success{
  0%{transform:scale(1);opacity:1}
  50%{transform:scale(1.08);opacity:.9}
  100%{transform:scale(1);opacity:1}
}

@keyframes shake-error{
  0%,100%{transform:translateX(0)}
  10%,30%,50%,70%,90%{transform:translateX(-4px)}
  20%,40%,60%,80%{transform:translateX(4px)}
}

@keyframes slide-in-up{
  from{transform:translateY(20px);opacity:0}
  to{transform:translateY(0);opacity:1}
}

@keyframes slide-in-down{
  from{transform:translateY(-20px);opacity:0}
  to{transform:translateY(0);opacity:1}
}

@keyframes fade-in{
  from{opacity:0}
  to{opacity:1}
}

/* Apply animations */
.opt.good{animation:pulse-success .4s ease-out}
.opt.bad{animation:shake-error .5s ease-out}
.card--q{animation:slide-in-up .3s ease-out}
.feedback{animation:slide-in-down .3s ease-out}
.fab-next{animation:fade-in .3s ease-out}
.badge[data-variant="accent"]{animation:fade-in .4s ease-out}
.drag-match-chip:active{transform:scale(.95);transition:.1s}

/* Responsive tweaks */
@media (max-width:640px){
  .head{flex-direction:column;align-items:flex-start}
  .match-grid{grid-template-columns:repeat(auto-fill,minmax(120px,1fr))}
  .drag-item-row{grid-template-columns:1fr 1fr}
  .flashcard{min-height:140px;padding:12px}
  .card--q{max-height:none} /* Remove height constraint on mobile */
  .options{grid-template-columns:1fr} /* Single column on mobile */
  .folder-stats-grid{grid-template-columns:repeat(2,1fr)} /* 2 cols for stats */
}

/* Extra small mobile (iPhone SE 375px) */
@media (max-width:400px){
  .wrap{padding:0 8px 16px}
  .topbar{flex-wrap:wrap;gap:8px}
  h1{font-size:18px}
  .card{padding:var(--space-3)}
  .btn{padding:6px 10px;font-size:13px}
  .flash-actions{flex-direction:column;gap:8px}
  .flash-actions .btn{width:100%}
  .folder-stats-grid{grid-template-columns:1fr} /* Single column stats on tiny screens */
}
